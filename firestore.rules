/**
 * @fileoverview Firestore Security Rules for the Citizen Complaint System.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for citizen data,
 * separating citizen and admin data into distinct collections. All data
 * is nested under a user-specific path (/citizens/{citizenId}/...) to
 * ensure that only the authenticated user can access their own data.
 *
 * Data Structure:
 * - /citizens/{citizenId}: Stores citizen profiles. The 'citizenId' MUST
 *   match the Firebase Auth UID of the user.
 * - /admins/{adminId}: Stores admin profiles. The 'adminId' MUST match
 *   the Firebase Auth UID of the admin.
 * - /citizens/{citizenId}/complaints/{complaintId}: Stores complaints
 *   submitted by citizens. The 'citizenId' in the path MUST match the
 *   'citizenId' property within the complaint document, enforcing ownership.
 * - /citizens/{citizenId}/feedback/{feedbackId}: Stores feedback submitted
 *   by citizens. The 'citizenId' in the path MUST match the 'citizenId'
 *   property within the feedback document, enforcing ownership.
 *
 * Key Security Decisions:
 * - User listing is disallowed for both citizens and admins.
 * - The rules explicitly deny any ambiguous or unspecified access.
 *
 * Denormalization for Authorization:
 * The 'citizenId' is duplicated in both the path and within the
 * Complaint and Feedback documents. This denormalization allows for
 * simple security rules that avoid costly 'get()' operations.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     * @returns {boolean} True if the request is authenticated, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     * @param {string} userId The user ID to compare against the authenticated user's UID.
     * @returns {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource and the resource exists.
     * @param {string} userId The user ID to compare against the authenticated user's UID.
     * @returns {boolean} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Rule for /citizens/{citizenId} documents.
     * @path /citizens/{citizenId}
     * @allow (create) User with UID 'user123' can create their own citizen document.
     *   request.auth.uid == 'user123' and request.resource.data.id == 'user123'
     * @deny (create) User with UID 'user123' cannot create a citizen document for another user ('user456').
     *   request.auth.uid == 'user123' and request.resource.data.id == 'user456'
     * @deny (read, write) Any user cannot read or modify other user citizen document.
     * @principle Enforces document ownership and self-creation for citizen profiles.
     */
    match /citizens/{citizenId} {
      allow get: if isOwner(citizenId);
      allow list: if false; // Listing citizens is not permitted.
      allow create: if isOwner(citizenId) && request.resource.data.id == citizenId;
      allow update: if isExistingOwner(citizenId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(citizenId);
    }

    /**
     * @description Rule for /admins/{adminId} documents.
     * @path /admins/{adminId}
     * @allow (create) Admin with UID 'admin123' can create their own admin document.
     *   request.auth.uid == 'admin123' and request.resource.data.id == 'admin123'
     * @deny (create) Admin with UID 'admin123' cannot create an admin document for another user ('admin456').
     *   request.auth.uid == 'admin123' and request.resource.data.id == 'admin456'
     * @deny (read, write) Any user cannot read or modify other user admin document.
     * @principle Enforces document ownership and self-creation for admin profiles.
     */
    match /admins/{adminId} {
      allow get: if isOwner(adminId);
      allow list: if false; // Listing admins is not permitted.
      allow create: if isOwner(adminId) && request.resource.data.id == adminId;
      allow update: if isExistingOwner(adminId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(adminId);
    }

    /**
     * @description Rule for /citizens/{citizenId}/complaints/{complaintId} documents.
     * @path /citizens/{citizenId}/complaints/{complaintId}
     * @allow (create) User with UID 'user123' can create a complaint under their citizen document.
     *   request.auth.uid == 'user123' and request.resource.data.citizenId == 'user123'
     * @deny (create) User with UID 'user123' cannot create a complaint under another user's citizen document.
     *   request.auth.uid == 'user123' and request.resource.data.citizenId == 'user456'
     * @deny (read, write) Any user cannot read or modify other user complaint document.
     * @principle Enforces document ownership for complaints.
     */
    match /citizens/{citizenId}/complaints/{complaintId} {
      allow get: if isOwner(citizenId);
      allow list: if isOwner(citizenId);
      allow create: if isOwner(citizenId) && request.resource.data.citizenId == citizenId;
      allow update: if isExistingOwner(citizenId) && resource.data.citizenId == citizenId;
      allow delete: if isExistingOwner(citizenId) && resource.data.citizenId == citizenId;
    }

    /**
     * @description Rule for /citizens/{citizenId}/feedback/{feedbackId} documents.
     * @path /citizens/{citizenId}/feedback/{feedbackId}
     * @allow (create) User with UID 'user123' can create feedback under their citizen document.
     *   request.auth.uid == 'user123' and request.resource.data.citizenId == 'user123'
     * @deny (create) User with UID 'user123' cannot create feedback under another user's citizen document.
     *   request.auth.uid == 'user123' and request.resource.data.citizenId == 'user456'
     * @deny (read, write) Any user cannot read or modify other user feedback document.
     * @principle Enforces document ownership for feedback.
     */
    match /citizens/{citizenId}/feedback/{feedbackId} {
      allow get: if isOwner(citizenId);
      allow list: if isOwner(citizenId);
      allow create: if isOwner(citizenId) && request.resource.data.citizenId == citizenId;
      allow update: if isExistingOwner(citizenId) && resource.data.citizenId == citizenId;
      allow delete: if isExistingOwner(citizenId) && resource.data.citizenId == citizenId;
    }
  }
}