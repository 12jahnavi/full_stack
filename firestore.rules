/**
 * @fileoverview Firestore Security Rules for the Citizen Complaint System.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for citizen data,
 * while allowing administrators to read and manage all complaints. It
 * separates citizen and admin data into distinct collections.
 *
 * Data Structure:
 * - /citizens/{citizenId}: Stores citizen profiles.
 * - /admins/{adminId}: Stores admin profiles. Used to check for admin privileges.
 * - /complaints/{complaintId}: Stores all complaints in a top-level collection.
 * - /feedback/{feedbackId}: Stores all feedback in a top-level collection.
 *
 * Key Security Decisions:
 * - Citizens can only create complaints and read/update/delete their own.
 * - Admins can read and update all complaints.
 * - User listing is disallowed for both citizens and admins.
 *
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     * @returns {boolean} True if the request is authenticated, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     * @param {string} userId The user ID to compare against the authenticated user's UID.
     * @returns {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * @description Checks if the authenticated user is the owner of the resource being acted upon.
     * It checks the 'citizenId' field within the document's data.
     * @param {object} docResource The resource object of the document.
     * @returns {boolean} True if the user's UID matches the document's citizenId.
     */
    function isDocumentOwner(docResource) {
      return isSignedIn() && request.auth.uid == docResource.data.citizenId;
    }

    /**
     * @description Checks if the requesting user is an admin.
     * Admins have their UID stored in the /admins collection.
     * @returns {boolean} True if the user is an admin.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    /**
     * @description Rule for /citizens/{citizenId} documents.
     * @path /citizens/{citizenId}
     * @principle Enforces document ownership and self-creation for citizen profiles.
     */
    match /citizens/{citizenId} {
      allow get: if isOwner(citizenId);
      allow list: if false; // Listing citizens is not permitted.
      allow create: if isOwner(citizenId) && request.resource.data.id == citizenId;
      allow update: if isOwner(citizenId) && request.resource.data.id == resource.data.id;
      allow delete: if isOwner(citizenId);
    }

    /**
     * @description Rule for /admins/{adminId} documents.
     * @path /admins/{adminId}
     * @principle Enforces document ownership and self-creation for admin profiles.
     */
    match /admins/{adminId} {
      allow get: if isOwner(adminId);
      allow list: if false; // Listing admins is not permitted.
      allow create: if isOwner(adminId) && request.resource.data.id == adminId;
      allow update: if isOwner(adminId) && request.resource.data.id == resource.data.id;
      allow delete: if isOwner(adminId);
    }

    /**
     * @description Rule for the top-level /complaints/{complaintId} collection.
     * @path /complaints/{complaintId}
     * @principle Citizens can create complaints, and can only read/update/delete their own.
     * Admins can read all complaints and update their status.
     */
    match /complaints/{complaintId} {
      // READ: Admins can read any complaint. Citizens can only read their own.
      allow get: if isAdmin() || isDocumentOwner(resource);
      // LIST: Admins can list all. Citizens can only list their own via a query.
      allow list: if isAdmin() || (isSignedIn() && request.query.where[0][1] == 'citizenId' && request.query.where[0][2] == request.auth.uid);

      // WRITE:
      // Create: Any signed-in user can create a complaint, but they must be the owner.
      allow create: if isSignedIn() && request.resource.data.citizenId == request.auth.uid;

      // Update: Admins can update any complaint. Citizens can only update their own.
      allow update: if isAdmin() || (isDocumentOwner(resource) && request.resource.data.citizenId == resource.data.citizenId);

      // Delete: Admins can delete any complaint. Citizens can only delete their own if it's 'Pending'.
      allow delete: if isAdmin() || (isDocumentOwner(resource) && resource.data.status == 'Pending');
    }

    /**
     * @description Rule for the top-level /feedback/{feedbackId} collection.
     * @path /feedback/{feedbackId}
     * @principle Citizens can create feedback, and can only manage their own. Admins can read all feedback.
     */
    match /feedback/{feedbackId} {
      allow get, list: if isAdmin() || isDocumentOwner(resource);
      allow create: if isSignedIn() && request.resource.data.citizenId == request.auth.uid;
      allow update, delete: if isDocumentOwner(resource);
    }
  }
}
