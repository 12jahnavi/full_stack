/**
 * @fileoverview Firestore Security Rules for the Citizen Complaint System.
 *
 * Core Philosophy:
 * This ruleset allows anyone (including anonymous users) to create complaints and feedback.
 * Only authenticated administrators can read the full list of complaints and
 * modify their status. Citizens can view any single complaint and list resolved complaints.
 *
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is from an authenticated user (can be anonymous).
     * @returns {boolean} True if the request has an auth object.
     */
    function isAuthenticated() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     * The user must be fully signed in (not anonymous).
     * @param {string} userId The user ID to compare against the authenticated user's UID.
     * @returns {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.token.firebase.sign_in_provider != "anonymous" && request.auth.uid == userId;
    }

    /**
     * @description Checks if the requesting user is an admin.
     * Admins have their UID stored in the /admins collection and must not be anonymous.
     * @returns {boolean} True if the user is an admin.
     */
    function isAdmin() {
      return request.auth.token.firebase.sign_in_provider != "anonymous" && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // Admins can manage their own profile.
    match /admins/{adminId} {
      allow read, write: if isOwner(adminId);
      // Deny listing of admins for security.
      allow list: if false;
    }
    
    // Citizens collection is no longer used, so deny all access.
    match /citizens/{citizenId} {
        allow read, write: if false;
    }

    /**
     * @description Rule for the top-level /complaints/{complaintId} collection.
     * @path /complaints/{complaintId}
     */
    match /complaints/{complaintId} {
      // READ (get): Any user (including anonymous) can read any single complaint.
      allow get: if isAuthenticated();
      
      // READ (list): 
      // - Admins can list all complaints.
      // - Any user can list complaints if they are querying for 'Resolved' ones.
      allow list: if isAdmin() || (isAuthenticated() && request.query.where.status == 'Resolved');

      // WRITE (create): Any authenticated user (including anonymous) can create a complaint.
      allow create: if isAuthenticated() && request.resource.data.citizenId == request.auth.uid;

      // WRITE (update, delete): Only admins can update or delete any complaint.
      allow update, delete: if isAdmin();
    }
    
    /**
     * @description Rule for the top-level /feedback/{feedbackId} collection.
     * @path /feedback/{feedbackId}
     * @principle Citizens can create feedback for any complaint. Admins can read all.
     */
    match /feedback/{feedbackId} {
      // READ: Admins can get any feedback document and list all feedback.
      allow read: if isAdmin();
      
      // WRITE (create): Any authenticated user (including anonymous) can create feedback,
      // as long as the citizenId in the feedback matches their own UID.
      allow create: if isAuthenticated() && request.resource.data.citizenId == request.auth.uid;

      // WRITE (update, delete): No one can update or delete feedback.
      allow update, delete: if false;
    }
  }
}
