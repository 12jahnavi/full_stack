/**
 * @fileoverview Firestore Security Rules for the Citizen Complaint System.
 *
 * Core Philosophy:
 * This ruleset allows anyone (including anonymous users) to create complaints.
 * Only authenticated administrators can read the full list of complaints and
 * modify their status. Citizen data is no longer stored, and complaints
 * are in a single top-level collection.
 *
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is from an authenticated (non-anonymous) user.
     * @returns {boolean} True if the request is authenticated, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null && request.auth.token.firebase.sign_in_provider != "anonymous";
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     * @param {string} userId The user ID to compare against the authenticated user's UID.
     * @returns {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the requesting user is an admin.
     * Admins have their UID stored in the /admins collection.
     * @returns {boolean} True if the user is an admin.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // Admins can manage their own profile.
    match /admins/{adminId} {
      allow read, write: if isOwner(adminId);
    }
    
    // Citizens collection is no longer used, so deny all access.
    match /citizens/{citizenId} {
        allow read, write: if false;
    }

    /**
     * @description Rule for the top-level /complaints/{complaintId} collection.
     * @path /complaints/{complaintId}
     * @principle Anyone can create. Admins can read all and update status.
     * Any user can query for their own complaints or resolved complaints.
     */
    match /complaints/{complaintId} {
      // READ (get): Admins can read any single complaint. Citizens can read their own.
      allow get: if isAdmin() || (request.auth != null && resource.data.citizenId == request.auth.uid);
      
      // READ (list): Admins can list all. Any user (including anon) can query for resolved complaints.
      allow list: if isAdmin() || 
                      (request.query.where[0][0] == 'status' &&
                       request.query.where[0][1] == '==' &&
                       request.query.where[0][2] == 'Resolved');

      // WRITE (create): Any user (including anonymous) can create a complaint.
      // We check that the citizenId in the document matches the user's uid, even if anonymous.
      allow create: if request.auth != null && request.resource.data.citizenId == request.auth.uid;

      // WRITE (update, delete): Only admins can update or delete any complaint.
      allow write: if isAdmin();
    }
    
    /**
     * @description Rule for the top-level /feedback/{feedbackId} collection.
     * @path /feedback/{feedbackId}
     * @principle Citizens can create feedback for resolved complaints. Admins can read all.
     */
    match /feedback/{feedbackId} {
      // READ: Admins can get any feedback document and list all feedback.
      allow read: if isAdmin();
      
      // WRITE (create): Any authenticated user (including anonymous) can create feedback,
      // as long as the citizenId in the feedback matches their own UID.
      // The complaint must also exist and be resolved.
      allow create: if request.auth != null && 
                      request.resource.data.citizenId == request.auth.uid &&
                      exists(/databases/$(database)/documents/complaints/$(request.resource.data.complaintId)) &&
                      get(/databases/$(database)/documents/complaints/$(request.resource.data.complaintId)).data.status == 'Resolved';

      // WRITE (update, delete): No one can update or delete feedback.
      allow update, delete: if false;
    }
  }
}
